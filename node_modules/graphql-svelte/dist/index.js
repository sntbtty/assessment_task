/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var e=function(){return(e=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function t(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))}function n(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function o(e){return{all:e=e||new Map,on:function(t,n){var o=e.get(t);o&&o.push(n)||e.set(t,[n])},off:function(t,n){var o=e.get(t);o&&o.splice(o.indexOf(n)>>>0,1)},emit:function(t,n){(e.get(t)||[]).slice().map((function(e){e(n)})),(e.get("*")||[]).slice().map((function(e){e(t,n)}))}}}function r(e){var t={url:"/graphql",method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}};return t.body=JSON.stringify(e),t}const i={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},s={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n};var c=function(e){let t=Number(s[32]),n=!1;for(let o=0;o<e.length;o++){let r=e.charCodeAt(o);r>127&&!n&&(r=(e=unescape(encodeURIComponent(e))).charCodeAt(o),n=!0),t^=r,t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24)}return t>>>0},a=function(e,{size:t=32}={}){if(!i[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");let n=s[t];const o=i[t];let r=!1;for(let i=0;i<e.length;i++){let s=e.charCodeAt(i);s>127&&!r&&(s=(e=unescape(encodeURIComponent(e))).charCodeAt(i),r=!0),n^=BigInt(s),n=BigInt.asUintN(t,n*o)}return n};function u(e,t){var n=this[e];if("undefined"!=typeof FormData&&n instanceof FormData){for(var o=void 0,r=n.entries(),i=r.next();!i.done;){var s=i.value;o+=""+s[0]+s[1],i=r.next()}return o}return t}c.bigInt=a;var h=function(e){return c(JSON.stringify(e,u)).toString(36)},l=o(),p=l.on,f=l.off,d=l.emit,y=function(e){var t=this,n=void 0===e?{}:e,o=n.cache,i=void 0===o?{}:o,s=n.cacheWrapper;this.on=p,this.off=f,this.emit=d,this.operations={},this.reload=function(e){t.emit("reload",{exceptCacheKey:e})},this.reset=function(e){var n=Object.keys(t.cache);e&&(n=n.filter((function(t){return t!==e}))),n.forEach((function(e){return delete t.cache[e]})),t.emit("reset",{exceptCacheKey:e})},this.fetch=function(e,n){var o,r=e.url,i=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n}(e,["url"]),s="function"==typeof fetch?fetch:function(){return Promise.reject(new Error("Global fetch API or polyfill unavailable."))},c={},a=s(r,i).then((function(e){return o=e,e.ok||(c.httpError={status:e.status,statusText:e.statusText}),e.json().then((function(e){var t=e.errors,n=e.data;t||n||(c.parseError="Malformed payload."),t&&(c.graphQLErrors=t),n&&(c.data=n)}),(function(e){var t=e.message;c.parseError=t}))}),(function(e){var t=e.message;c.fetchError=t})).then((function(){return t.cache[n]=t.cacheWrapper?t.cacheWrapper(c):c,delete t.operations[n],t.emit("cache",{cacheKey:n,cacheValue:c,response:o}),c}));return t.operations[n]=a,t.emit("fetch",{cacheKey:n,cacheValuePromise:a}),a},this.operate=function(e){var n=e.operation,o=e.fetchOptionsOverride,i=e.reloadOnLoad,s=e.resetOnLoad;if(i&&s)throw new Error("operate() options “reloadOnLoad” and “resetOnLoad” can’t both be true.");var c=r(n);o&&o(c);var a=h(c),u=t.operations[a]||t.fetch(c,a);return u.then((function(){i?t.reload(a):s&&t.reset(a)})),{cacheKey:a,cacheValue:t.cache[a],cacheValuePromise:u}},this.cache=i,this.cacheWrapper=s};function v(e){var t=e.cacheKey,n=e.cacheValue,o=n.fetchError,r=n.httpError,i=n.parseError,s=n.graphQLErrors;(o||r||i||s)&&(console.groupCollapsed("GraphQL cache errors for key “"+t+"”:"),o&&(console.groupCollapsed("Fetch:"),console.log(o),console.groupEnd()),r&&(console.groupCollapsed("HTTP:"),console.log("Status: "+r.status),console.log("Text: "+r.statusText),console.groupEnd()),i&&(console.groupCollapsed("Parse:"),console.log(i),console.groupEnd()),s&&(console.groupCollapsed("GraphQL:"),s.forEach((function(e){var t=e.message;return console.log(t)})),console.groupEnd()),console.groupEnd())}var m=b;function b(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}b.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},b.prototype.reset=function(){this.attempts=0};var g=function(e){var t,n=e.Symbol;if("function"==typeof n)if(n.observable)t=n.observable;else{t=n.for("https://github.com/benlesh/symbol-observable");try{n.observable=t}catch(e){}}else t="@@observable";return t}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),w=o(),E=w.on,T=w.emit;function C(e){return"string"==typeof e}var O=function(){function o(e,t){void 0===t&&(t={}),this.operations={},this.eventEmitter=T;var n=t||{},o=n.connectionCallback,r=void 0===o?void 0:o,i=n.connectionParams,s=void 0===i?{}:i,c=n.timeout,a=void 0===c?3e4:c,u=n.reconnect,h=void 0!==u&&u,l=n.reconnectionAttempts,p=void 0===l?1/0:l,f=n.lazy,d=void 0!==f&&f,y=n.inactivityTimeout,v=void 0===y?0:y;this.wsImpl=WebSocket,this.connectionCallback=r,this.url=e,this.operations={},this.nextOperationId=0,this.wsTimeout=a,this.unsentMessagesQueue=[],this.reconnect=h,this.reconnecting=!1,this.reconnectionAttempts=p,this.lazy=!!d,this.inactivityTimeout=v,this.closedByUser=!1,this.backoff=new m({jitter:.5}),this.client=null,this.maxConnectTimeGenerator=this.createMaxConnectTimeGenerator(),this.connectionParams=this.getConnectionParams(s),this.lazy||this.connect()}return Object.defineProperty(o.prototype,"status",{get:function(){return null===this.client?this.wsImpl.CLOSED:this.client.readyState},enumerable:!1,configurable:!0}),o.prototype.close=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0),this.clearInactivityTimeout(),null!==this.client&&(this.closedByUser=t,e&&(this.clearCheckConnectionInterval(),this.clearMaxConnectTimeout(),this.clearTryReconnectTimeout(),this.unsubscribeAll(),this.sendMessage(void 0,"connection_terminate",null)),this.client.close(),this.client=null,this.eventEmitter("disconnected"),e||this.tryReconnect())},o.prototype.request=function(e){var t,n,o=this.getObserver.bind(this),r=this.executeOperation.bind(this),i=this.unsubscribe.bind(this);return this.clearInactivityTimeout(),(t={})[g.default?g.default:g]=function(){return this},t.subscribe=function(t,s,c){var a=o(t,s,c);return n=r(e,(function(e,t){null===e&&null===t?a.complete&&a.complete():e?a.error&&a.error(e[0]):a.next&&a.next(t)})),{unsubscribe:function(){n&&(i(n),n=null)}}},t},o.prototype.on=function(e,t,n){E(e,t)},o.prototype.onConnected=function(e,t){return this.on("connected",e,t)},o.prototype.onConnecting=function(e,t){return this.on("connecting",e,t)},o.prototype.onDisconnected=function(e,t){return this.on("disconnected",e,t)},o.prototype.onReconnected=function(e,t){return this.on("reconnected",e,t)},o.prototype.onReconnecting=function(e,t){return this.on("reconnecting",e,t)},o.prototype.onError=function(e,t){return this.on("error",e,t)},o.prototype.unsubscribeAll=function(){var e=this;Object.keys(this.operations).forEach((function(t){e.unsubscribe(t)}))},o.prototype.getConnectionParams=function(e){return function(){return new Promise((function(t,n){if("function"==typeof e)try{return t(e(null))}catch(e){return n(e)}t(e)}))}},o.prototype.executeOperation=function(e,t){null===this.client&&this.connect();var n=this.generateOperationId();this.operations[n]={options:e,handler:t};try{this.checkOperationOptions(e,t),this.operations[n]&&(this.operations[n]={options:e,handler:t},this.sendMessage(n,"start",e))}catch(e){this.unsubscribe(n),t(this.formatErrors(e))}return n},o.prototype.getObserver=function(e,t,n){return"function"==typeof e?{next:function(t){return e(t)},error:function(e){return t&&t(e)},complete:function(){return n&&n()}}:e},o.prototype.createMaxConnectTimeGenerator=function(){var e=this.wsTimeout;return new m({min:1e3,max:e,factor:1.2})},o.prototype.clearCheckConnectionInterval=function(){this.checkConnectionIntervalId&&(clearInterval(this.checkConnectionIntervalId),this.checkConnectionIntervalId=null)},o.prototype.clearMaxConnectTimeout=function(){this.maxConnectTimeoutId&&(clearTimeout(this.maxConnectTimeoutId),this.maxConnectTimeoutId=null)},o.prototype.clearTryReconnectTimeout=function(){this.tryReconnectTimeoutId&&(clearTimeout(this.tryReconnectTimeoutId),this.tryReconnectTimeoutId=null)},o.prototype.clearInactivityTimeout=function(){this.inactivityTimeoutId&&(clearTimeout(this.inactivityTimeoutId),this.inactivityTimeoutId=null)},o.prototype.setInactivityTimeout=function(){var e=this;this.inactivityTimeout>0&&0===Object.keys(this.operations).length&&(this.inactivityTimeoutId=setTimeout((function(){0===Object.keys(e.operations).length&&e.close()}),this.inactivityTimeout))},o.prototype.checkOperationOptions=function(e,t){var n,o=e.query,r=e.variables,i=e.operationName;if(!o)throw new Error("Must provide a query.");if(!t)throw new Error("Must provide an handler.");if(!C(o)||i&&!C(i)||r&&(null===(n=r)||"object"!=typeof n))throw new Error("Incorrect option types. query must be a string,`operationName` must be a string, and `variables` must be an object.")},o.prototype.buildMessage=function(e,t,n){return{id:e,type:t,payload:n&&n.query?Object.assign({},n,{query:n.query}):n}},o.prototype.formatErrors=function(e){return Array.isArray(e)?e:e&&e.errors?this.formatErrors(e.errors):e&&e.message?[e]:[{name:"FormatedError",message:"Unknown error",originalError:e}]},o.prototype.sendMessage=function(e,t,n){this.sendMessageRaw(this.buildMessage(e,t,n))},o.prototype.sendMessageRaw=function(e){switch(this.status){case this.wsImpl.OPEN:var t=JSON.stringify(e);try{JSON.parse(t)}catch(t){this.eventEmitter("error",new Error("Message must be JSON-serializable. Got: "+e))}this.client.send(t);break;case this.wsImpl.CONNECTING:this.unsentMessagesQueue.push(e);break;default:this.reconnecting||this.eventEmitter("error",new Error("A message was not sent because socket is not connected, is closing or is already closed. Message was: "+JSON.stringify(e)))}},o.prototype.generateOperationId=function(){return String(++this.nextOperationId)},o.prototype.tryReconnect=function(){var e=this;if(this.reconnect&&!(this.backoff.attempts>=this.reconnectionAttempts)){this.reconnecting||(Object.keys(this.operations).forEach((function(t){e.unsentMessagesQueue.push(e.buildMessage(t,"start",e.operations[t].options))})),this.reconnecting=!0),this.clearTryReconnectTimeout();var t=this.backoff.duration();this.tryReconnectTimeoutId=setTimeout((function(){e.connect()}),t)}},o.prototype.flushUnsentMessagesQueue=function(){var e=this;this.unsentMessagesQueue.forEach((function(t){e.sendMessageRaw(t)})),this.unsentMessagesQueue=[]},o.prototype.checkConnection=function(){this.wasKeepAliveReceived?this.wasKeepAliveReceived=!1:this.reconnecting||this.close(!1,!0)},o.prototype.checkMaxConnectTimeout=function(){var e=this;this.clearMaxConnectTimeout(),this.maxConnectTimeoutId=setTimeout((function(){e.status!==e.wsImpl.OPEN&&(e.reconnecting=!0,e.close(!1,!0))}),this.maxConnectTimeGenerator.duration())},o.prototype.connect=function(){var e=this;this.client=new WebSocket(this.url,"graphql-ws"),this.checkMaxConnectTimeout(),this.client.addEventListener("open",(function(){return t(e,void 0,void 0,(function(){var e,t;return n(this,(function(n){switch(n.label){case 0:if(this.status!==this.wsImpl.OPEN)return[3,4];this.clearMaxConnectTimeout(),this.closedByUser=!1,this.eventEmitter(this.reconnecting?"reconnecting":"connecting"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.connectionParams()];case 2:return e=n.sent(),this.sendMessage(void 0,"connection_init",e),this.flushUnsentMessagesQueue(),[3,4];case 3:return t=n.sent(),this.sendMessage(void 0,"connection_error",t),this.eventEmitter("error",t),this.flushUnsentMessagesQueue(),[3,4];case 4:return[2]}}))}))})),this.client.onclose=function(){e.closedByUser||e.close(!1,!1)},this.client.addEventListener("error",(function(t){e.eventEmitter("connection_error",t)})),this.client.addEventListener("message",(function(t){var n=t.data;e.processReceivedData(n)}))},o.prototype.processReceivedData=function(t){var n,o;try{o=(n=JSON.parse(t)).id}catch(e){throw new Error("Message must be JSON-parseable. Got: "+t)}if(!["data","complete","error"].includes(n.type)||this.operations[o])switch(n.type){case"connection_error":this.connectionCallback&&this.connectionCallback(n.payload);break;case"connection_ack":this.eventEmitter(this.reconnecting?"reconnected":"connected"),this.reconnecting=!1,this.backoff.reset(),this.maxConnectTimeGenerator.reset(),this.connectionCallback&&this.connectionCallback();break;case"complete":this.operations[o].handler(null,null),delete this.operations[o];break;case"error":this.eventEmitter("error",this.formatErrors(n.payload)),this.operations[o].handler(this.formatErrors(n.payload),null),delete this.operations[o];break;case"data":var r=n.payload.errors?e(e({},n.payload),{errors:this.formatErrors(n.payload.errors)}):n.payload;this.operations[o].handler(null,r);break;case"ka":var i=void 0===this.wasKeepAliveReceived;this.wasKeepAliveReceived=!0,i&&this.checkConnection(),this.checkConnectionIntervalId&&(clearInterval(this.checkConnectionIntervalId),this.checkConnection()),this.checkConnectionIntervalId=setInterval(this.checkConnection.bind(this),this.wsTimeout);break;default:throw new Error("Invalid message type!")}else this.unsubscribe(o)},o.prototype.unsubscribe=function(e){this.operations[e]&&(delete this.operations[e],this.setInactivityTimeout(),this.sendMessage(e,"stop",void 0))},o}();function I(e,t){return new O(e,t)}var k={},x={"content-type":"application/json"};function M(){return x}var j=Object.freeze({__proto__:null,client:k,setHeaders:function(e){x=e},headers:M,getClient:function(t){var n,o=t.url,i=t.wsUrl,s=t.wsOptions,c=void 0===s?{}:s,a=t.graphqlOptions,u=new y(void 0===a?{}:a),l=function(e){e.url=o,e.headers=M()};function p(t,n,o,i){void 0===i&&(i=function(e){return e});var s=r(e({},n));t(s);var c=h(s);return i(c),u.cache[c]&&u.cache[c].graphQLErrors&&delete u.cache[c],u.cache[c]&&o?new Promise((function(e){return e(u.cache[c])})):u.operate({fetchOptionsOverride:t,operation:e({},n)}).cacheValuePromise.then((function(e){return u.cache[c]}))}if(k.graphql=u,i){var f=I(i,e({reconnect:(n=c).reconnect||!0,lazy:n.lazy||!0},n.connectionParams?{connectionParams:n.connectionParams}:{connectionParams:function(){return{headers:M()}}}));k.subscription=function(e){var t=e.query,n=e.variables;return f.request({query:t,variables:n})},k.sub=f}return k.mutate=function(e){var t=e.query,n=e.variables,o=e.cache,r=void 0!==o&&o,i=e.key;return p(l,{query:t,variables:n},r,i)},k.query=function(e){var t=e.query,n=e.variables,o=e.cache,r=void 0===o||o,i=e.key;return p(l,{query:t,variables:n},r,i)},k}});export{y as GraphQL,I as SubscribeQL,r as graphqlFetchOptions,h as hashObject,v as reportCacheErrors,j as svqlConfig};
//# sourceMappingURL=index.js.map
